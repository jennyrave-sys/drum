<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jennyrave house techno drum machine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MIDI Generation Library -->
    <script src="https://cdn.jsdelivr.net/npm/midi-writer-js/browser/midiwriter.js"></script>
    <!-- ZIP Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #020617;
            --panel-glass: rgba(15, 23, 42, 0.85);
            --accent-blue: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.4);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.12) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(99, 102, 241, 0.08) 0px, transparent 50%);
            color: #f8fafc;
            user-select: none;
            overflow: hidden; /* Prevent scrolling as requested */
            height: 100vh;
        }

        .glass {
            background: var(--panel-glass);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        }

        .step-btn {
            aspect-ratio: 1 / 1;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: rgba(30, 41, 59, 0.4);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .step-active {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            box-shadow: 
                0 0 12px rgba(59, 130, 246, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.4) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        .step-current {
            transform: scale(1.05);
            z-index: 20;
            outline: 2px solid #fbbf24;
            outline-offset: 1px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 3px;
            background: rgba(51, 65, 85, 0.6);
            border-radius: 2px;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
        }

        .mono { font-family: 'JetBrains+Mono', monospace; }

        .mute-active {
            background-color: #ef4444 !important;
            color: white !important;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
            border-color: #ef4444 !important;
        }

        .lock-active {
            background-color: #fbbf24 !important;
            color: #0f172a !important;
            box-shadow: 0 0 12px rgba(251, 191, 36, 0.3);
            border-color: #fbbf24 !important;
        }

        .steps-locked {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(0.5);
        }

        .track-row {
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.03);
            height: calc((100vh - 280px) / 8); 
            min-height: 44px;
            max-height: 75px;
        }

        .track-row:hover {
            background: rgba(30, 41, 59, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .global-btn {
            height: 36px;
            padding: 0 12px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 9px;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .main-play-btn {
            height: 44px;
            padding: 0 24px;
            background: #10b981;
            color: #020617;
            font-weight: 900;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        ::-webkit-scrollbar { width: 0px; height: 0px; }
    </style>
</head>
<body class="p-2 lg:p-4 flex items-center justify-center">

    <div class="w-full h-full max-w-[1500px] max-h-[950px] glass rounded-[2rem] flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="p-4 lg:p-5 border-b border-white/5 bg-slate-900/30 flex flex-col lg:flex-row lg:items-center justify-between gap-4 shrink-0">
            <div>
                <h1 class="text-xs lg:text-sm font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white via-blue-100 to-slate-400 uppercase leading-tight">
                    jennyrave<br>
                    <span class="text-white/60">house techno</span><br>
                    <span class="text-slate-400 font-bold">drum machine</span>
                </h1>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <button id="playBtn" class="main-play-btn hover:bg-emerald-400 active:scale-95 shadow-[0_5px_15px_rgba(16,185,129,0.2)]">
                    <svg id="playIcon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 17.5V2.5L16.5 10L4.5 17.5Z"></path></svg>
                    <span>START MACHINE</span>
                </button>
                
                <div class="bg-slate-950/40 p-2 px-4 rounded-xl border border-white/5 flex items-center gap-4 h-11">
                    <div class="flex flex-col">
                        <span class="text-[7px] font-bold text-slate-500 uppercase tracking-widest leading-none">BPM</span>
                        <span id="bpmDisplay" class="text-sm font-black text-blue-400 leading-tight">126</span>
                    </div>
                    <input type="range" id="bpmSlider" min="60" max="220" value="126" class="w-20">
                </div>

                <div class="flex flex-wrap items-center gap-1.5 bg-slate-950/40 p-1.5 rounded-xl border border-white/5 h-11">
                    <button id="shuffleBtn" class="global-btn bg-slate-800 text-slate-200 hover:bg-slate-700">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span>NEW KIT</span>
                    </button>
                    
                    <button id="randomPatternBtn" class="global-btn bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/30">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        <span>RANDOM PATTERN</span>
                    </button>

                    <button id="saveKitBtn" class="global-btn bg-blue-600/20 text-blue-400 hover:bg-blue-600/30">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        <span>SAVE KIT</span>
                    </button>

                    <button id="saveMidiBtn" class="global-btn bg-amber-600/20 text-amber-400 hover:bg-amber-600/30">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span>SAVE MIDI</span>
                    </button>

                    <button id="clearBtn" class="global-btn bg-red-950/30 text-red-500 hover:bg-red-500/20">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <span>CLEAR PATTERN</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Sequencer Grid -->
        <main class="flex-grow flex flex-col p-3 lg:p-4 overflow-hidden">
            <div id="sequencer" class="flex-grow flex flex-col gap-1.5 overflow-hidden">
                <!-- Tracks Injected -->
            </div>
        </main>

        <!-- Footer -->
        <footer class="px-6 py-2 border-t border-white/5 bg-slate-950/60 flex justify-between items-center text-[8px] uppercase tracking-widest text-slate-500 font-extrabold h-10 shrink-0">
            <div class="flex items-center gap-4">
                <div id="statusMessage" class="flex items-center gap-2"><span class="w-1 h-1 rounded-full bg-emerald-500"></span> Ready</div>
                <div id="kitInfo">Mapping Matrix...</div>
            </div>
            <div class="flex items-center gap-4">
                <div id="debugLog" class="hidden md:block opacity-60 lowercase font-medium">jennyrave.sys.engine</div>
                <div class="mono text-blue-400 bg-blue-500/10 px-3 py-1 rounded-md border border-blue-500/10" id="stepCounter">Pos: 01</div>
            </div>
        </footer>
    </div>

    <!-- Splash Loader -->
    <div id="loader" class="fixed inset-0 bg-[#020617] z-50 flex flex-col items-center justify-center transition-all duration-1000">
        <div class="relative w-20 h-20 mb-6">
            <div class="absolute inset-0 border-2 border-blue-500/10 rounded-full"></div>
            <div class="absolute inset-0 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-4 border border-indigo-500/20 border-b-transparent rounded-full animate-spin-slow"></div>
        </div>
        <h2 class="text-white font-black tracking-[0.4em] uppercase text-[11px] mb-2 text-center px-10 leading-relaxed">
            jennyrave<br>house techno drum machine
        </h2>
        <p id="loaderDetail" class="text-slate-500 text-[8px] mono tracking-[0.3em] opacity-60 animate-pulse uppercase">Syncing techno engine...</p>
    </div>

    <script>
        const REPO_API = 'https://api.github.com/repos/jennyrave-sys/drum/contents/';
        const CATEGORY_MAP = [
            { id: 'kick', label: 'Kick', prefix: '1', midiNote: 'C1' },
            { id: 'snare', label: 'Snare', prefix: '2', midiNote: 'D1' },
            { id: 'chh', label: 'Closed HH', prefix: '3', midiNote: 'F#1' },
            { id: 'ohh', label: 'Open HH', prefix: '4', midiNote: 'A#1' },
            { id: 'clap', label: 'Clap', prefix: '5', midiNote: 'D#1' },
            { id: 'p1', label: 'Perc 1', prefix: 'p', midiNote: 'G1' }, 
            { id: 'p2', label: 'Perc 2', prefix: 'p', midiNote: 'A1' }, 
            { id: 'p3', label: 'Perc 3', prefix: 'p', midiNote: 'B1' }  
        ];

        let audioCtx = null, isPlaying = false, bpm = 126, currentStep = 0, nextNoteTime = 0.0, timerID = null, tracks = [], discoveredFiles = [];
        const playBtn = document.getElementById('playBtn'), bpmSlider = document.getElementById('bpmSlider'), bpmDisplay = document.getElementById('bpmDisplay'), loader = document.getElementById('loader'), loaderDetail = document.getElementById('loaderDetail'), statusMessage = document.getElementById('statusMessage'), debugLog = document.getElementById('debugLog'), kitInfo = document.getElementById('kitInfo');
        const generateExportId = () => Math.floor(1000 + Math.random() * 9000);

        async function discoverRepoFiles() {
            try {
                const res = await fetch(REPO_API);
                if (!res.ok) return false;
                discoveredFiles = (await res.json()).filter(f => f.name.toLowerCase().endsWith('.wav')).map(f => ({ name: f.name, url: f.download_url }));
                return discoveredFiles.length > 0;
            } catch (e) { return false; }
        }

        function pickUniqueFile(prefix, shuffle, usedUrls, currentUrl = null) {
            let matches = discoveredFiles.filter(f => f.name.toLowerCase().startsWith(prefix.toLowerCase()) && !usedUrls.includes(f.url));
            if (shuffle && currentUrl && matches.length > 1) {
                const diff = matches.filter(f => f.url !== currentUrl);
                if (diff.length > 0) matches = diff;
            }
            if (matches.length === 0) return discoveredFiles.find(f => f.name.toLowerCase().startsWith(prefix.toLowerCase()));
            return shuffle ? matches[Math.floor(Math.random() * matches.length)] : matches[0];
        }

        async function initApp(shuffle = false) {
            loader.style.display = 'flex'; loader.style.opacity = '1';
            if (!discoveredFiles.length) { loaderDetail.textContent = "Negotiating handshake..."; await discoverRepoFiles(); }
            const usedUrls = [];
            const newTracks = CATEGORY_MAP.map(def => {
                const existing = tracks.find(t => t.id === def.id);
                if (shuffle && existing && existing.locked) { if (existing.downloadUrl) usedUrls.push(existing.downloadUrl); return { ...existing }; }
                const fileObj = pickUniqueFile(def.prefix, shuffle, usedUrls, existing ? existing.downloadUrl : null);
                if (fileObj) usedUrls.push(fileObj.url);
                return { ...def, fileName: fileObj ? fileObj.name : 'Missing.wav', downloadUrl: fileObj ? fileObj.url : null, rawBuffer: null, decodedBuffer: null, volume: existing ? existing.volume : 0.8, muted: existing ? existing.muted : false, locked: existing ? existing.locked : false, steps: existing ? existing.steps : new Array(16).fill(false) };
            });
            for (let track of newTracks) {
                if (track.rawBuffer && track.decodedBuffer) continue;
                if (!track.downloadUrl) continue;
                loaderDetail.textContent = `Wiring ${track.label}...`;
                try {
                    const res = await fetch(track.downloadUrl);
                    if (res.ok) { track.rawBuffer = await res.arrayBuffer(); if (audioCtx) track.decodedBuffer = await audioCtx.decodeAudioData(track.rawBuffer.slice(0)); }
                } catch (e) {}
            }
            tracks = newTracks; renderGrid();
            kitInfo.textContent = `${tracks.length} Channels Loaded`;
            if (!shuffle) loadPreset();
            loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 1000);
        }

        function renderGrid() {
            const container = document.getElementById('sequencer'); container.innerHTML = '';
            tracks.forEach(track => {
                const row = document.createElement('div'); row.className = 'track-row flex items-center gap-2 px-4 rounded-xl overflow-hidden';
                
                const info = document.createElement('div'); info.className = 'flex items-center gap-1 w-auto shrink-0';
                
                const labelContainer = document.createElement('div'); 
                labelContainer.className = 'flex flex-col w-20 shrink-0 min-w-0 pr-1';
                const label = document.createElement('span'); label.className = `text-[9px] font-black uppercase tracking-widest truncate ${track.rawBuffer ? 'text-slate-100' : 'text-red-500'}`; label.textContent = track.label;
                const subLabel = document.createElement('span'); subLabel.className = 'text-[8px] text-slate-500 font-bold mono truncate opacity-50'; subLabel.textContent = track.fileName;
                labelContainer.appendChild(label); labelContainer.appendChild(subLabel);
                
                const ctrl = document.createElement('div'); ctrl.className = 'flex items-center gap-1 bg-slate-900/50 p-1 rounded-lg border border-white/5';
                const vol = document.createElement('input'); vol.type = 'range'; vol.min = '0'; vol.max = '1'; vol.step = '0.01'; vol.value = track.volume; vol.className = 'w-24 h-1 mx-1.5'; vol.oninput = (e) => track.volume = parseFloat(e.target.value);
                const mute = document.createElement('button'); mute.className = `w-6 h-6 flex items-center justify-center rounded-md border border-slate-700/50 transition-all text-slate-400 ${track.muted ? 'mute-active' : ''}`; mute.innerHTML = `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`; mute.onclick = () => { track.muted = !track.muted; renderGrid(); };
                const lock = document.createElement('button'); lock.className = `w-6 h-6 flex items-center justify-center rounded-md border border-slate-700/50 transition-all text-slate-400 ${track.locked ? 'lock-active' : ''}`; lock.innerHTML = `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>`; lock.onclick = () => { track.locked = !track.locked; renderGrid(); };
                
                ctrl.appendChild(vol); ctrl.appendChild(mute); ctrl.appendChild(lock); 
                info.appendChild(labelContainer); info.appendChild(ctrl); 
                row.appendChild(info);
                
                const pads = document.createElement('div'); pads.className = `flex-grow grid grid-cols-16 gap-1.5 transition-all ${track.locked ? 'steps-locked' : ''}`; pads.style.display = 'grid'; pads.style.gridTemplateColumns = 'repeat(16, 1fr)';
                for (let i = 0; i < 16; i++) {
                    const btn = document.createElement('button'); const beat = i % 4 === 0; btn.className = `step-btn rounded-md ${beat ? 'bg-white/5 border-white/10' : 'bg-slate-900/40 border-white/5'} hover:bg-slate-700/40`;
                    if (track.steps[i]) btn.classList.add('step-active'); btn.onclick = () => { if (!track.rawBuffer || track.locked) return; track.steps[i] = !track.steps[i]; btn.classList.toggle('step-active'); if (track.steps[i] && track.decodedBuffer && !track.muted) playHit(track.decodedBuffer, 0, track.volume); }; pads.appendChild(btn);
                }
                row.appendChild(pads); container.appendChild(row);
            });
        }

        function playHit(buffer, time, volume) { if (!audioCtx || !buffer) return; const s = audioCtx.createBufferSource(), g = audioCtx.createGain(); s.buffer = buffer; g.gain.setValueAtTime(volume, time || audioCtx.currentTime); s.connect(g); g.connect(audioCtx.destination); s.start(time || audioCtx.currentTime); }
        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + 0.1) {
                tracks.forEach(track => { if (track.steps[currentStep] && track.decodedBuffer && !track.muted) playHit(track.decodedBuffer, nextNoteTime, track.volume); });
                const sIdx = currentStep; const hTime = nextNoteTime;
                setTimeout(() => {
                    document.querySelectorAll('.step-current').forEach(el => el.classList.remove('step-current'));
                    const rows = document.getElementById('sequencer').children;
                    for (let r = 0; r < rows.length; r++) { const b = rows[r].children[1]?.children[sIdx]; if (b) b.classList.add('step-current'); }
                    document.getElementById('stepCounter').textContent = `Pos: ${(sIdx + 1).toString().padStart(2, '0')}`;
                }, Math.max(0, (hTime - audioCtx.currentTime) * 1000));
                nextNoteTime += 0.25 * (60.0 / bpm); currentStep = (currentStep + 1) % 16;
            }
            timerID = setTimeout(scheduler, 25);
        }

        playBtn.onclick = async () => {
            if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); for (let t of tracks) if (t.rawBuffer && !t.decodedBuffer) try { t.decodedBuffer = await audioCtx.decodeAudioData(t.rawBuffer.slice(0)); } catch(e) {} }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            if (isPlaying) { isPlaying = false; clearTimeout(timerID); playBtn.className = "main-play-btn bg-emerald-500 hover:bg-emerald-400 active:scale-95"; playBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 17.5V2.5L16.5 10L4.5 17.5Z"></path></svg><span>START MACHINE</span>`; }
            else { isPlaying = true; currentStep = 0; nextNoteTime = audioCtx.currentTime + 0.05; scheduler(); playBtn.className = "main-play-btn bg-orange-500 hover:bg-orange-400 active:scale-95 shadow-[0_5px_15px_rgba(249,115,22,0.2)]"; playBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6 4h4v12H6V4zm6 0h4v12h-4V4z"></path></svg><span>STOP MACHINE</span>`; }
        };

        bpmSlider.oninput = (e) => { bpm = e.target.value; bpmDisplay.textContent = bpm; };
        document.getElementById('shuffleBtn').onclick = () => initApp(true);
        document.getElementById('clearBtn').onclick = () => { tracks.forEach(t => { if (!t.locked) t.steps.fill(false); }); renderGrid(); };
        document.getElementById('randomPatternBtn').onclick = () => {
            tracks.forEach(track => {
                if (track.locked) return; track.steps.fill(false);
                switch(track.id) {
                    case 'kick': [0, 4, 8, 12].forEach(s => track.steps[s] = true); if(Math.random() > 0.7) track.steps[14] = true; break;
                    case 'snare': case 'clap': track.steps[4] = true; track.steps[12] = true; break;
                    case 'ohh': [2, 6, 10, 14].forEach(s => { if(Math.random() > 0.1) track.steps[s] = true; }); break;
                    case 'chh':
                        const v = Math.random();
                        if (v < 0.15) [0, 2, 4, 6, 8, 10, 12, 14].forEach(s => track.steps[s] = true);
                        else if (v < 0.3) track.steps.fill(true);
                        else if (v < 0.5) [2, 6, 10, 14].forEach(s => track.steps[s] = true);
                        else if (v < 0.7) [0, 3, 6, 8, 11, 14].forEach(s => track.steps[s] = true);
                        else if (v < 0.85) [0, 1, 2, 4, 5, 6, 8, 9, 10, 12, 13, 14].forEach(s => track.steps[s] = true);
                        else { [0, 4, 8, 12].forEach(s => track.steps[s] = true); [1, 5, 9, 13].forEach(s => { if(Math.random() > 0.5) track.steps[s] = true; }); }
                        break;
                    default: const sync = [1, 3, 5, 7, 9, 11, 13, 15]; const count = Math.floor(Math.random() * 3) + 2; for(let i=0; i < count; i++) track.steps[sync[Math.floor(Math.random() * sync.length)]] = true; break;
                }
            });
            renderGrid();
        };

        document.getElementById('saveMidiBtn').onclick = () => {
            if (!tracks.length) return;
            const t = new MidiWriter.Track(); t.setTempo(bpm);
            for (let s = 0; s < 16; s++) {
                const n = []; tracks.forEach(track => { if (!track.muted && track.steps[s]) n.push(track.midiNote); });
                if (n.length > 0) t.addEvent(new MidiWriter.NoteEvent({ pitch: n, duration: '16', sequential: false }));
                else t.addEvent(new MidiWriter.NoteEvent({ pitch: [], duration: '16' }));
            }
            const data = (new MidiWriter.Writer(t)).buildFile();
            const blob = new Blob([data], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob); const eid = generateExportId(); const a = document.createElement('a'); a.href = url; a.download = `jennyrave_${bpm}bpm_${eid}.mid`; a.click();
        };

        document.getElementById('saveKitBtn').onclick = async () => {
            if (!tracks.length) return;
            const z = new JSZip(); let count = 0;
            tracks.forEach(track => { if (track.rawBuffer) { z.file(`${track.id}_${track.fileName}`, track.rawBuffer); count++; } });
            if (count === 0) return;
            const b = await z.generateAsync({ type: "blob" });
            const url = URL.createObjectURL(b); const eid = generateExportId(); const a = document.createElement('a'); a.href = url; a.download = `jennyrave_kit_${eid}.zip`; a.click();
        };

        function loadPreset() {
            if(tracks[0]) [0, 4, 8, 12].forEach(s => tracks[0].steps[s] = true);
            if(tracks[1]) [4, 12].forEach(s => tracks[1].steps[s] = true);
            if(tracks[2]) [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15].forEach(s => tracks[2].steps[s] = true);
            if(tracks[3]) [2, 6, 10, 14].forEach(s => tracks[3].steps[s] = true);
            if(tracks[4]) [4, 12].forEach(s => tracks[4].steps[s] = true);
            if(tracks[5]) [3, 11].forEach(s => tracks[5].steps[s] = true);
            if(tracks[6]) [7, 15].forEach(s => tracks[6].steps[s] = true);
            if(tracks[7]) [5, 13].forEach(s => tracks[7].steps[s] = true);
            renderGrid();
        }

        window.onload = async () => { await initApp(); };
    </script>
</body>
</html>
